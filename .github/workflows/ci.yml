name: Licant CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-arduino2560:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host and AVR toolchains
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3 python3-pip \
            gcc-avr binutils-avr avr-libc

      - name: Install licant
        run: |
          sudo python3 -m pip install licant

      - name: Fetch licant libraries sources
        run: |
          git clone https://github.com/mirmik/igris       || true
          git clone https://github.com/mirmik/nos         || true
          git clone https://github.com/mirmik/onboardtest || true

      - name: Register licant libraries
        run: |
          set -e
          list_of_directories="\
              igris \
              nos \
              onboardtest \
          "
          for directory in $list_of_directories
          do
            if [ -d "$directory" ]; then
              echo "licant-libs $directory"
              sudo licant-libs "./$directory"
            else
              echo "Skip $directory (not found)"
            fi
          done

      - name: Build arduino2560-firmware.elf
        run: |
          python3 make.py arduino2560-firmware.elf

  build-stm32:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3 python3-pip

      - name: Install ARM GCC 9-2019-q4-major
        run: |
          cd $HOME
          wget https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2019q4/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2
          tar xf gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2
          echo "$HOME/gcc-arm-none-eabi-9-2019-q4-major/bin" >> $GITHUB_PATH

      - name: Show ARM toolchain version
        run: |
          arm-none-eabi-gcc --version
          arm-none-eabi-g++ --version

      - name: Install licant
        run: |
          sudo python3 -m pip install licant

      - name: Fetch licant libraries sources
        run: |
          git clone https://github.com/mirmik/igris       || true
          git clone https://github.com/mirmik/nos         || true
          git clone https://github.com/mirmik/onboardtest || true

      - name: Register licant libraries
        run: |
          set -e
          list_of_directories="\
              igris \
              nos \
              onboardtest \
          "
          for directory in $list_of_directories
          do
            if [ -d "$directory" ]; then
              echo "licant-libs $directory"
              sudo licant-libs "./$directory"
            else
              echo "Skip $directory (not found)"
            fi
          done

      - name: Build stm32-firmware.elf
        run: |
          python3 make.py stm32-firmware.elf

  build-stm32h7:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3 python3-pip

      - name: Install ARM GCC 9-2019-q4-major
        run: |
          cd $HOME
          wget https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2019q4/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2
          tar xf gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2
          echo "$HOME/gcc-arm-none-eabi-9-2019-q4-major/bin" >> $GITHUB_PATH

      - name: Show ARM toolchain version
        run: |
          arm-none-eabi-gcc --version
          arm-none-eabi-g++ --version

      - name: Install licant
        run: |
          sudo python3 -m pip install licant

      - name: Fetch licant libraries sources
        run: |
          git clone https://github.com/mirmik/igris       || true
          git clone https://github.com/mirmik/nos         || true
          git clone https://github.com/mirmik/onboardtest || true

      - name: Register licant libraries
        run: |
          set -e
          list_of_directories="\
              igris \
              nos \
              onboardtest \
          "
          for directory in $list_of_directories
          do
            if [ -d "$directory" ]; then
              echo "licant-libs $directory"
              sudo licant-libs "./$directory"
            else
              echo "Skip $directory (not found)"
            fi
          done

      - name: Build stm32h7-firmware.elf
        run: |
          python3 make.py stm32h7-firmware.elf

  build-and-test-host:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3 python3-pip

      - name: Install licant
        run: |
          sudo python3 -m pip install licant

      - name: Fetch licant libraries sources
        run: |
          git clone https://github.com/mirmik/igris       || true
          git clone https://github.com/mirmik/nos         || true
          git clone https://github.com/mirmik/onboardtest || true

      - name: Register licant libraries
        run: |
          set -e
          list_of_directories="\
              igris \
              nos \
              onboardtest \
          "
          for directory in $list_of_directories
          do
            if [ -d "$directory" ]; then
              echo "licant-libs $directory"
              sudo licant-libs "./$directory"
            else
              echo "Skip $directory (not found)"
            fi
          done

      - name: Build runtests
        run: |
          python3 make.py runtests

      - name: Run tests
        run: |
          ./runtests
